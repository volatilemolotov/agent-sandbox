{{- $file := (.Get "file") -}}
{{- $md := resources.Get $file -}}

{{/* Remove first heading */}}
{{- $content := replaceRE `(\s*#[^\n$]*\n*)` "" $md.Content 1 -}}

{{/* Get the current page's section path */}}
{{- $pagePath := .Page.RelPermalink -}}
{{- $sectionPath := replaceRE "/[^/]+/$" "/" $pagePath -}}

{{/* Load link replacement rules from data file */}}
{{- $rules := .Site.Data.link_replacements.replacements -}}

{{/* Apply each replacement rule */}}
{{- range $rules -}}
  {{- if .dynamic -}}
    {{/* Dynamic replacement using current section path */}}
    {{- $content = replaceRE .pattern (printf "](%s$1)" (strings.TrimSuffix "/" $sectionPath)) $content -}}
  {{- else -}}
    {{/* Static replacement from YAML */}}
    {{- $content = replaceRE .pattern .replacement $content -}}
  {{- end -}}
{{- end -}}

{{- $content | markdownify -}}
